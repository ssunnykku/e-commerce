## 성능 테스트 보고서

### 1. 목적

- 시스템 병목 구간 탐색 및 개선 방향 제시
- 장애 대응 문서 작성
- 병목 구간과 개선점에 대한 해결책 제시

---

### 2. 테스트 대상 API

| API | 기능                                      |
| --- |-----------------------------------------|
| `GET /balance/{userId}` | 사용자 잔액 조회                               |
| `POST /balance/charge` | 잔액 충전                                   |
| `GET /products/{id}` | 특정 상품 1개 조회                             |
| `GET /products` | 전체 상품 리스트 조회 (페이지네이션 적용, 인기 상품 캐싱 적용)   |
| `GET /products/top-selling` | 상위 5개 상품 조회 (Redis 캐싱 적용)               |
| `POST /coupons/issue` | 쿠폰 발급 (재고 관리 Redis 적용, 쿠폰 대기열 kafka 적용) |
| `POST /orders` | 상품 주문, 결제 (멀티락 적용, 쿠폰·결제 트랜잭션 통합)       |

---

### 3. 테스트 환경

- 도구: **k6**
- 시나리오:
    - **Load 테스트:** 5분, 최대 VUs 1000, 목표 TPS 750
    - **Stress 테스트:** 14분, 최대 VUs 1500, 단계적 증가
    - **Peak 테스트:** 5분, 최대 VUs 600, 목표 TPS 850
---

### 4. 테스트 시나리오 비율
### 4.1 Load 테스트, Stress 테스트
| 행위 | 비율 |
| --- | --- |
| 상품 목록 조회 | 35% |
| 인기 상품 조회 | 25% |
| 상품 상세 조회 | 20% |
| 잔액 조회 | 5% |
| 주문/결제 | 10% |
| 잔액 충전 | 5% |

### 4.2 Peak 테스트 (쿠폰 발급 테스트)
| 기능  | 비율(%) |
| ---  | --- |
| 쿠폰 발급  | 70.6 |
| 상품 목록 조회  | 11.8 |
| 주문/결제| 5.9 |
| 잔액 조회  | 11.8 |
| **합계** | 100 |
---

### 5. Load 테스트 결과 (TPS 750)


| 항목 | 값 |
| --- | --- |
| 총 요청 수 | 215,033 |
| 성공률 | 84.91% |
| 실패률 | 15.08% |
| 주문 API 성공률 | 0% |
| 잔액 충전 API 성공률 | 0% |
| 평균 응답 시간 | 114ms |
| 최대 응답 시간 | 4.8s |

---

### 6. Stress 테스트 결과

| 항목 | 값 |
| --- | --- |
| 총 요청 수 | 100,918 |
| 성공률 | 82.85% |
| 실패률 | 17.14% |
| 주문 API 성공률 | 0% |
| 평균 응답 시간 | 3.71s |
| 최대 응답 시간 | 35.75s |

---

### 7. Peak 테스트 결과

| 항목 | 값 |
| --- | --- |
| 총 요청 수 | 37,776 |
| 성공률 | 23.51% |
| 실패률 | 76.48% |
| 주문 API 성공률 | 0% |
| 쿠폰 발급 API 성공률 | 0% |
| 평균 응답 시간 | 3.78s |
| 최대 응답 시간 | 18.05s |

---

### 8. 분석 및 개선점

### 8.1 주문/결제 API

| 테스트 | 총 요청 수 | 성공률 | 평균 응답 시간 | 최대 응답 시간 |
| --- | --- | --- | --- | --- |
| Load | 21,686 | 0% | 114ms | 4.8s |
| Stress | 9,961 | 0% | 3.71s | 35.75s |
| Peak | 2,143 | 0% | 3.78s | 18.05s |

**문제점:**

- 모든 테스트에서 주문 API 성공률 0% → 멀티락 + 단일 트랜잭션으로 동시 처리 불가
- Stress/Peak 테스트에서 평균/최대 응답 시간 급증 → 요청이 대기 상태로 쌓임
- Peak 테스트에서 CPU 리소스 부족으로 추가 지연 발생 가능 (VUs 600 도달 시 Insufficient VUs 경고)

**개선안:**

- 트랜잭션 분리: 주문, 재고, 결제, 쿠폰 사용
- 일부 비동기 처리 → 응답 지연 최소화
- CPU 사용량 모니터링, 필요 시 스케일 아웃/Auto-scaling 적용

---

### 8.2 쿠폰 발급 API

| 테스트 | 총 요청 수 | 성공률 | 평균 응답 시간 | 최대 응답 시간 |
| --- | --- | --- | --- | --- |
| Peak | 26,749 | 0% | 3.78s | 18.05s |

**문제점:**

- Peak 테스트에서 성공률 0% → 단일 트랜잭션 및 Kafka 대기열 처리 지연
- CPU 리소스 부족으로 처리 지연 발생 가능

**개선안:**

- Redis 인메모리 카운터 활용, 발급 여부 비동기 처리
- 경쟁 상태 최소화
- CPU 사용량 모니터링, 필요 시 스케일 아웃/Auto-scaling 적용

---

### 8.3 상품 조회 API

| 테스트 | 총 요청 수 | 성공률 | 평균 응답 시간 | 최대 응답 시간 |
| --- | --- | --- | --- | --- |
| Load | 43,000 | 97% | 114ms | 1.2s |
| Stress | 32,000 | 97% | 320ms | 5.1s |
| Peak | 12,000 | 98% | 310ms | 3.5s |

**상태:**

- 페이지네이션, 인덱싱, 캐싱 적용 완료된 상태로 지표 상태 양호

---

### 8.4 잔액 조회/충전 API

| 테스트 | 총 요청 수 | 성공률 | 평균 응답 시간 | 최대 응답 시간 |
| --- | --- | --- | --- | --- |
| Load | 10,758 | 0% (충전) / 100% (조회) | 114ms | 4.8s |
| Stress | 4,995 | 0% (충전) / 97% (조회) | 3.71s | 35.75s |
| Peak | 1,200 | 조회 95% / 충전 — | 3.78s | 18.05s |

**문제점:**

- 잔액 조회는 모든 테스트에서 안정적 처리되고 있으나, 충전의 경우 성공률이 0%

**개선안:**

- Peak 테스트에도 충전 API 포함 → 실제 부하에서 처리 여부 확인
- DistributedLock 영향 및 로직 동작 추가 테스트, 개선 필요

---

## 9. 장애 대응

### 9.1 주요 장애 유형

1. **주문/결제 동시 요청 실패**
  - 원인: 멀티락 + 트랜잭션 통합으로 인해 동시성 제한 발생
  - 결과: TPS가 증가하면 주문 요청 100% 실패, 응답 지연 발생

2. **쿠폰 발급/재고 관리 장애**
  - 원인: Redis/트랜잭션 단일 처리 및 Kafka 대기열 처리 지연
  - 결과: 대량 요청 시 쿠폰 발급 실패, 재고 반영 지연

3. **DB 과부하**
  - 원인: 조회/결제 요청 폭주, 트랜잭션 락 대기
  - 결과: 응답 지연, 일부 요청 실패

4. **네트워크 지연**
  - 원인: 외부 시스템(Redis, Kafka, DB) 호출 증가
  - 결과: 평균 응답 시간 상승, Peak 테스트에서 실패율 급증

### 9.2 대응 방안

- **트랜잭션 분리**
  - 주문/결제/쿠폰 발급을 개별 트랜잭션으로 처리
- **비동기 처리**
  - 결제 승인, 쿠폰 발급, 재고 반영 일부 비동기 처리
- **DB 최적화**
  - 인덱싱, 페이지네이션 적용
  - 읽기 전용 Replica DB 활용
- **캐싱**
  - 인기 상품 Redis 캐싱, TTL 관리
  - 잔액 조회/충전 캐시 활용
- **모니터링**
  - CPU, 메모리, DB 연결 수, 레이턴시 모니터링
  - 알람 및 Auto-scaling 적용

---

## 12. 결론 및 개선점

- **문제 요약**
  - 주문/결제 API 동시 처리 실패 → 멀티락 + 트랜잭션 통합이 원인
  - 쿠폰 발급 TPS 제한 → 단일 트랜잭션 및 Kafka 대기열 지연
  - Peak/Stress 테스트 시 일부 조회 API 지연 → DB 과부하 및 캐시 활용 부족

- **개선 방안**
  - 주문/결제/쿠폰 발급 트랜잭션 분리
  - 멀티락 최소화 (상품/사용자 단위 세분화)
  - 일부 비동기 처리 적용
  - Redis 캐시 활용 및 TTL 관리
  - DB 읽기 전용 Replica, 인덱싱 최적화
  - 모니터링과 Auto-scaling 연동

- **기대 효과**
  - TPS 증가 시 주문/결제 성공률 향상
  - Peak/Stress 테스트에서 응답 지연 최소화
  - 전체 시스템 안정성 및 사용자 경험 개선