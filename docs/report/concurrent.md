# 📄 동시성 문제 해결 방안 보고서

## 1. 개요

본 보고서는 서비스 내 다음 세 가지 기능에서 발생할 수 있는 **동시성 문제**를 식별하고, 이를 **트랜잭션**, **DB Lock**, **트랜잭션 격리 수준** 등을 활용하여 안정적으로 해결하기 위한 전략을 제시합니다.

### 주요 기능

- ✅ **상품 재고 차감 및 복원**
- ✅ **유저 포인트 충전**
- ✅ **선착순 쿠폰 발급**

---

## 2. 트랜잭션과 격리 수준

### 🔐 격리 수준: `REPEATABLE READ` (MySQL 기본 설정)

- **선택 이유**:
    - `READ COMMITTED`보다 강한 고립성 제공
    - 같은 트랜잭션 내에서 반복 조회 시 항상 같은 결과를 보장
    - **팬텀 리드(phantom read)**는 방지하지 않지만, InnoDB에서는 **Next-Key Lock**을 통해 팬텀 리드를 대부분 해결
- **적절한 사용 시점**:
    - 반복 조회나 상태 검증이 중요한 **재고 확인**, **포인트 충전**, **쿠폰 수량 검사** 등에 적합

---

## 트랜잭션 전파
- ✅ **상품 재고 차감 및 복원**
  - 
- ✅ **유저 포인트 충전**
  - ??? 그 history -> required new 설정
- ✅ **선착순 쿠폰 발급**
  - 

## 3. 동시성 문제 식별 및 해결 전략
### 동시성 문제 식별
- ✅ **상품 재고 차감 및 복원**
  - 교착상태(Dead lock) 발생 가능성
- ✅ **유저 포인트 충전/사용**
  - 두개의 브라우저에서 동시 충전 시도
  - 
- ✅ **선착순 쿠폰 발급**
  - 

### 해결 전략


---

### 🧾 1. 유저 포인트 충전 → **낙관적 락 적용**

#### ✅ 문제
- 동일한 사용자가 동시에 포인트를 충전하거나 사용하는 경우 데이터 불일치 가능성
- 예: 두 요청이 동일한 시점에 조회 → 둘 다 `잔액: 1000`으로 보고 → 각각 500 차감 → 실제 잔액은 `0`이어야 하지만 `500`이 되는 문제 발생
- 동시에 포인트 충전 요청 (각 1000원) -> 총 2000원이 충전되어야 하나, 분실 갱신으로 1000원만 충전되는 문제


#### ✅ 해결 전략: **낙관적 락 (Optimistic Lock)**
- 버전 필드(`@Version`)를 이용한 충돌 감지
- 충돌 발생 시 재시도를 통해 해결

#### ✅ 선택 이유
- 단일 사용자 자원에 대한 접근이므로 충돌 가능성이 낮음
- 재시도 비용이 크지 않고, 충돌이 발생하더라도 사용자 경험에 크게 영향을 주지 않음
- 비관적 락 사용 시 오히려 락 경합으로 성능 저하 가능

---

### 📦 2. 상품 재고 차감 및 복원 → **비관적 락 적용**

#### ✅ 문제
- 인기 상품의 경우 여러 사용자가 동시에 재고를 차감하려는 경쟁 상황 발생
- 재고 부족 시 낙관적 락으로 재시도하면 반복해서 실패 → 오히려 비효율
- 잘못하면 **재고 마이너스**, **주문 실패 누락**, **데드락** 등의 문제 발생

#### ✅ 해결 전략: **비관적 락 (Pessimistic Lock)**
- `SELECT ... FOR UPDATE`로 락을 걸어 다른 트랜잭션의 접근 차단
- 트랜잭션 내에서 안전하게 재고를 확인하고 차감

#### ✅ 선택 이유
- 실시간 경쟁이 매우 빈번하게 발생하는 영역
- 실패 시 빠르게 사용자에게 안내하고, 불필요한 재시도 방지

---

### 🎫 3. 선착순 쿠폰 발급 → **비관적 락 적용**

#### ✅ 문제
- 제한된 수량의 쿠폰을 다수의 사용자가 동시에 발급 받으려 할 경우
  - 3개의 쿠폰 발급 -> 동시성 문제로 Race condition 문제 발생 가능 -> 쿠폰을 정상적으로 발급받지 못한다.
- 중복 쿠폰(한명이 두개 발급) ??
- 
++++ 선착순 쿠폰 사용 (동시 사용 금지)

#### ✅ 해결 전략: **비관적 락 (Pessimistic Lock)**
- 쿠폰 발급 전에 해당 쿠폰 타입에 대해 `FOR UPDATE` 락을 걸어 수량 차감

#### ✅ 선택 이유
- 선착순이라는 특성상 **순서를 보장해야 하며**, 실패 시 빠르게 사용자에게 안내하는 것이 낫다고 판단
- 낙관적 락의 재시도 과정은 오히려 **리소스 낭비** 및 사용자 경험 저하

---

## 4. 종합 판단 및 결론

| 기능 | 적용 전략 | 이유 |
|------|------------|------|
| 유저 포인트 충전 | 낙관적 락 | 충돌 적고, 재시도 비용이 낮음 |
| 상품 재고 차감 | 비관적 락 | 실시간 경쟁이 치열하고, 낙관적 재시도는 무의미 |
| 쿠폰 발급 | 비관적 락 | 선착순 처리에 적합, 실패를 빠르게 감지해야 함 |

- 동시성 처리에서 가장 중요한 것은 **기능의 특성(경쟁 가능성, 충돌 발생 빈도)**에 따라 락 전략을 다르게 가져가는 것
- 트랜잭션 격리 수준은 기본값인 `REPEATABLE READ`를 유지하여 반복 조회 시 일관성을 보장


